<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>忘年会 席決め</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            /* 背景：紙吹雪パターン */
            background-color: #2c3e50;
            background-image: radial-gradient(#f1c40f 15%, transparent 16%), radial-gradient(#e74c3c 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            text-align: center;
            width: 90%;
            max-width: 700px;
            position: relative;
            border: 5px solid #fff;
        }

        h1 { 
            font-size: 2.2rem; 
            margin-bottom: 1.5rem; 
            color: #c0392b; 
            text-shadow: 2px 2px 0 #fff;
            font-weight: 900;
        }

        /* 入力エリア */
        .input-group {
            display: flex; justify-content: center; align-items: center;
            gap: 15px; margin-bottom: 30px; font-size: 1.5rem;
        }
        input[type="number"] {
            padding: 15px; font-size: 1.5rem; width: 100px; text-align: center;
            border: 3px solid #ddd; border-radius: 12px;
        }

        /* --- 豪華なチケットエリア --- */
        .seat-view {
            background: #fffaf0; /* クリーム色 */
            border: 8px double #d4af37; /* 金色の二重線 */
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            min-height: 350px;
            display: flex; justify-content: center; align-items: center;
        }

        /* チケットの四隅の飾り */
        .seat-view::before, .seat-view::after {
            content: "★";
            position: absolute;
            font-size: 2rem;
            color: #d4af37;
        }
        .seat-view::before { top: 10px; left: 10px; }
        .seat-view::after { bottom: 10px; right: 10px; }
        
        .seat-inner {
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .seat-title {
            font-size: 2rem; 
            color: #d4af37; 
            font-weight: bold; 
            letter-spacing: 5px; 
            margin-bottom: 5px;
            text-transform: uppercase;
            text-shadow: 1px 1px 0px #eee;
        }

        .result-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .number-display {
            font-size: 11rem;
            font-weight: 900; 
            color: #333; 
            line-height: 1;
            margin: 10px 0; 
            text-shadow: 4px 4px 0px #f1c40f; 
        }

        /* 面白画像 */
        .surprise-img {
            max-width: 220px;
            max-height: 220px;
            border-radius: 15px;
            border: 6px solid #e74c3c;
            transform: rotate(-10deg);
            box-shadow: 10px 10px 20px rgba(0,0,0,0.3);
            display: none;
            background: #fff;
        }
        .surprise-img.show {
            display: block;
            animation: popImage 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* びっくり箱 */
        .gift-box {
            font-size: 9rem;
            display: none;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3));
        }
        .gift-box.shaking {
            display: block;
            animation: shake 0.5s infinite;
        }

        .status-text {
            color: #7f8c8d; margin-bottom: 20px; font-size: 1.2rem; font-weight: bold;
        }

        /* --- ボタン類 --- */
        button { 
            cursor: pointer; border: none; border-radius: 60px; font-weight: bold; transition: 0.1s; 
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
        }
        button:active { 
            transform: translateY(5px);
            box-shadow: none;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: translateY(5px); }

        .btn-primary {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            color: white;
            font-size: 2.5rem; padding: 20px 60px; width: 90%;
            margin-bottom: 20px; 
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }

        .btn-start {
            background-color: #2ecc71; color: white;
            padding: 15px 40px; font-size: 1.5rem; margin-top: 20px;
        }

        .control-panel { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .btn-mini { padding: 12px 25px; font-size: 1rem; color: white; }
        .bg-gray { background-color: #95a5a6; }
        .bg-purple { background-color: #9b59b6; }
        .bg-red { background-color: #34495e; }

        /* モーダル */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 15px;
            width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; text-align: center;
        }
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 8px; margin: 15px 0;
        }
        .grid-item {
            border: 1px solid #ddd; border-radius: 8px; padding: 10px 0; font-weight: bold; font-size: 1.1rem;
            position: relative; background-color: #fff; color: #333;
        }
        .grid-item.drawn { background-color: #bdc3c7; color: #fff; border-color: #bdc3c7; }
        .grid-item.drawn::after {
            content: "済"; position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white;
            font-size: 0.7rem; padding: 2px 5px; border-radius: 4px;
        }

        /* 紙吹雪アニメーション */
        .confetti {
            position: fixed; width: 10px; height: 10px; background-color: #f1c40f;
            position: absolute; top: -10px; z-index: 9999;
            animation: fall linear forwards;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }

        /* 各種アニメーション */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        @keyframes pop { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes popImage { 0% { transform: scale(0) rotate(0deg); } 100% { transform: scale(1) rotate(-10deg); } }
        .pop-in { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <audio id="drum-sound" src="drumroll.mp3" preload="auto"></audio>
    <audio id="normal-sound" src="normal.mp3" preload="auto"></audio>
    <audio id="tada-sound" src="tada.mp3" preload="auto"></audio>

    <div class="container">
        <div id="setup-screen">
            <h1>🎉 忘年会 席決め</h1>
            <p style="font-size: 1.2rem;">担当する番号の範囲</p>
            <div class="input-group">
                <input type="number" id="min-num" value="1" min="1">
                <span>～</span>
                <input type="number" id="max-num" value="50" min="1">
            </div>
            <button class="btn-start" onclick="initApp()">パーティー開始！</button>
        </div>

        <div id="main-screen" class="hidden">
            <h1 style="font-size: 2rem; color: #333;">あなたの席は...</h1>
            
            <div class="seat-view">
                <div class="seat-inner">
                    <div class="seat-title">SEAT No.</div>
                    
                    <div id="gift-box" class="gift-box">🎁</div>

                    <div id="result-area" class="result-container">
                        <div id="display" class="number-display">?</div>
                        <img id="special-img" class="surprise-img" src="" alt="Lucky!">
                    </div>

                </div>
            </div>

            <button id="draw-btn" class="btn-primary" onclick="startDrawSequence()">くじを引く！</button>
            <div id="count-info" class="status-text">残り: - 席</div>

            <div class="control-panel">
                <button class="btn-mini bg-purple" onclick="openStatusModal()">📊 確認</button>
                <button id="undo-btn" class="btn-mini bg-gray" onclick="undo()" disabled>↩ 戻す</button>
                <button class="btn-mini bg-red" onclick="resetApp()">⚙ 終了</button>
            </div>
        </div>
    </div>

    <div id="status-modal" class="modal hidden" onclick="closeStatusModal(event)">
        <div class="modal-content">
            <h3 class="modal-title">決定済みリスト</h3>
            <div id="status-grid" class="grid-container"></div>
            <button class="btn-mini bg-gray" style="font-size: 1rem; padding: 10px 30px;" onclick="document.getElementById('status-modal').classList.add('hidden')">閉じる</button>
        </div>
    </div>

    <script>
        // ==========================================
        //  👇 設定エリア
        // ==========================================
        const funnyImages = ["photo02.JPG", "photo04.JPG", "photo06.JPG", "photo11.JPG", "photo13.JPG"];
        const imageProbability = 0.3; // 30%の確率で面白画像
        
        // 音声要素
        const drumSound = document.getElementById("drum-sound");
        const normalSound = document.getElementById("normal-sound");
        const tadaSound = document.getElementById("tada-sound");
        // ==========================================

        let availableNumbers = [], historyStack = [];
        let minNum = 1, maxNum = 50, totalCount = 0;
        let isAnimating = false;

        function initApp() {
            minNum = parseInt(document.getElementById('min-num').value);
            maxNum = parseInt(document.getElementById('max-num').value);
            if (!minNum || !maxNum || minNum > maxNum) { alert("範囲を正しく入力してください"); return; }

            availableNumbers = [];
            for (let i = minNum; i <= maxNum; i++) availableNumbers.push(i);
            totalCount = availableNumbers.length;
            historyStack = [];

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
            
            document.getElementById('display').innerText = "Ready";
            updateStatus();

            // モバイルでの音再生制限を解除するため、一度ミュートで再生
            [drumSound, normalSound, tadaSound].forEach(sound => {
                sound.volume = 0;
                sound.play().then(() => {
                    sound.pause();
                    sound.currentTime = 0;
                    sound.volume = 1;
                }).catch(() => {});
            });
        }

        function startDrawSequence() {
            if (isAnimating) return;
            if (availableNumbers.length === 0) { alert("全ての席が決まりました！"); return; }

            isAnimating = true;
            const btn = document.getElementById('draw-btn');
            btn.disabled = true;

            document.getElementById('result-area').classList.add('hidden');
            document.getElementById('special-img').classList.remove('show');
            document.getElementById('display').classList.remove('pop-in');

            const box = document.getElementById('gift-box');
            box.classList.remove('hidden');
            box.classList.add('shaking');

            // 🥁 ドラムロール再生
            drumSound.currentTime = 0;
            drumSound.play().catch(e => console.log(e));

            // 1秒後に結果発表
            setTimeout(() => {
                drumSound.pause(); // ドラムロール停止

                box.classList.remove('shaking');
                box.classList.add('hidden');
                drawNumberLogic();
                isAnimating = false;
                if (availableNumbers.length > 0) btn.disabled = false;
            }, 2000); 
        }

        function drawNumberLogic() {
            const randomIndex = Math.floor(Math.random() * availableNumbers.length);
            const selectedNumber = availableNumbers[randomIndex];

            availableNumbers.splice(randomIndex, 1);
            historyStack.push({ number: selectedNumber, hasImage: false });

            const displayEl = document.getElementById('display');
            displayEl.innerText = selectedNumber;
            
            const imgEl = document.getElementById('special-img');
            const shouldShowImage = (Math.random() < imageProbability) && (funnyImages.length > 0);
            
            if (shouldShowImage) {
                // ✨ 大当たり（画像あり）
                const randomImgIndex = Math.floor(Math.random() * funnyImages.length);
                imgEl.src = funnyImages[randomImgIndex];
                imgEl.classList.add('show');
                historyStack[historyStack.length - 1].hasImage = true;
                historyStack[historyStack.length - 1].imgSrc = funnyImages[randomImgIndex];
                
                // 🎉 ファンファーレ＆紙吹雪
                playSound(tadaSound);
                showConfetti();
            } else {
                // 🎵 通常当選
                imgEl.classList.remove('show');
                playSound(normalSound);
            }

            document.getElementById('result-area').classList.remove('hidden');
            displayEl.classList.add('pop-in');
            
            updateStatus();
            document.getElementById('undo-btn').disabled = false;

            if (availableNumbers.length === 0) {
                document.getElementById('draw-btn').innerText = "完了";
                document.getElementById('draw-btn').disabled = true;
            }
        }

        function playSound(audioObj) {
            audioObj.currentTime = 0;
            audioObj.play().catch(e => console.log(e));
        }

        function showConfetti() {
            const colors = ['#f1c40f', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                confetti.style.opacity = Math.random();
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        function undo() {
            if (historyStack.length === 0) return;
            const lastEntry = historyStack[historyStack.length - 1];
            if (!confirm(`【 ${lastEntry.number}番 】を箱に戻しますか？`)) return;

            historyStack.pop();
            availableNumbers.push(lastEntry.number);
            availableNumbers.sort((a, b) => a - b);

            document.getElementById('display').innerText = "Ready";
            document.getElementById('special-img').classList.remove('show');
            document.getElementById('undo-btn').disabled = true;

            updateStatus();
            document.getElementById('draw-btn').disabled = false;
            document.getElementById('draw-btn').innerText = "くじを引く！";
        }

        function updateStatus() {
            document.getElementById('count-info').innerText = `残り: ${availableNumbers.length} / ${totalCount} 席`;
        }

        function openStatusModal() {
            const grid = document.getElementById('status-grid');
            grid.innerHTML = "";
            for (let i = minNum; i <= maxNum; i++) {
                const div = document.createElement('div');
                div.classList.add('grid-item');
                div.innerText = i;
                if (!availableNumbers.includes(i)) div.classList.add('drawn');
                grid.appendChild(div);
            }
            document.getElementById('status-modal').classList.remove('hidden');
        }

        function closeStatusModal(e) {
            if (e.target.id === 'status-modal') e.target.classList.add('hidden');
        }

        function resetApp() {
            if (confirm("設定に戻りますか？履歴は消えます。")) location.reload();
        }
    </script>
</body>
</html>